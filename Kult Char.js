// ==UserScript==
// @name         KULT: Character Generator
// @author       巫洁鸾
// @version      1.0
// @description  KULT: Divinity Lost 角色生成器。v1.0:自动抽取角色，分配描述，实现属性数值的自动随机分配，优化展示格式。
// @license      MIT
// ==/UserScript==

let ext = seal.ext.find('KultCharGen');
if (!ext) {
    ext = seal.ext.new('KultCharGen', '巫洁鸾', '1.0');
    seal.ext.register(ext);
}

// === 1. 核心数据库 ===
const KULT_LIBRARY = {
    // 全局列表
    global: {
        identities: [], // 初始化时自动填充
        disadvantages: [
            "恶名昭彰", "支离破碎", "竞争对手", "在劫难逃", "诅咒缠身", "郁病泥沼", "毒品成瘾", "实验出错", "狂热信徒", "贪财好利", 
            "罪责困心", "骚扰频发", "鬼魂附身", "病弱之躯", "失控通灵", "妒心难控", "满口谎话", "身份剥离", "黑暗印记", "精神性强迫症", 
            "血海深仇", "噩梦困扰", "复仇誓言", "魂牵梦绕", "妄想症", "禁脔", "恐惧症", "理性主义者", "压抑记忆", "敌意横生", 
            "精神分裂", "性神经官能病", "跟踪者", "激情难抑", "身负通缉"
        ],
        secrets: [
            "天选之人", "咒根深种", "家族秘密", "禁忌知识", "看护者", "罪行愧责", "继承者", "精神疾病", "秘学体验", "黑暗契约", 
            "医学实验负责人", "彼岸返客", "居无定所", "离奇失踪", "犯罪受害者", "医学实验受害者", "显灵"
        ],
        distractions: [
            "约会服务", "讨论论坛", "锻炼健身", "时尚潮流", "室内装饰", "在线游戏", "色情制品", "现实电视", "购物消遣", "社交平台", "电视剧"
        ]
    },
    // 属性定义
    attributes: {
        passive_names: ["体魄", "反应", "意志"],
        passive_values: ["+2", "+1", "+0"],
        active_names: ["魅力", "冷静", "直觉", "感知", "逻辑", "灵魂", "暴力"],
        active_values: ["+3", "+2", "+1", "+1", "+0", "-1", "-2"]
    },
    // 原型数据
    archetypes: {
        "学术家": {
            identity: "教授、学生、博士候选人、教师、公务员、顾问、政客、作家、电视秀主持人、贵族、研究员、心理学家、考古学家、业余爱好者、古文物研究者",
            secrets: ["禁忌知识", "看护者", "秘学体验", "彼岸返客", "离奇失踪"],
            disadvantages: { options: ["噩梦困扰", "妄想症", "恐惧症", "压抑记忆", "理性主义者", "跟踪者"], mandatory: [] },
            traits: ["学界人脉(魅力)", "权威人士(魅力)", "精英教育(魅力)", "奇珍收藏(逻辑)", "资料检索(逻辑)", "领域专家(逻辑)", "秘术研习(逻辑)", "运动专长(-)"],
            looks: {
                clothes: "粗花呢质地、轻松随性、略显宽松、斑斓多彩、端庄适当、西装革履、休闲洒脱、书卷气息、古典旧式",
                face: "稚气未脱、圆润可人、饱经沧桑、倦容满面、清秀苍白、坚毅方正、比例怪异、俊逸修长、鹰钩鼻型、相貌平平、英俊挺拔、岁月留痕、蓄须浓密",
                eyes: "审视怀疑、盈满自负、深沉思辨、泰然自若、充满好奇、腼腆羞涩、智慧闪烁、心神飘忽、权威彰显、戴着眼镜、透露疲惫",
                body: "纤细瘦削、圆润丰腴、高挑挺拔、若隐若现、身体弯曲、无力憔悴、健美强壮、形态走样、动作迟缓、线条分明、僵硬不便、身体残疾、大腹便便、肥胖饱满、矮小精悍、紧实结实、浓密多毛"
            },
            relations: ["选一位角色为同窗好友。彼此建立+1情感关系。", "选一位角色是你的亲戚。", "选一位角色在研讨会上结识。", "选一位角色作为研究助手。", "选一位角色是你的爱人，你对他建立+1或+2情感关系。"]
        },
        "特工": {
            identity: "开源分析官、情报官员、反恐分析员、分析方法学家、特别探员、安全专家、行动人员、收集管理官、管理者、卧底、间谍、潜伏特工",
            secrets: ["禁忌知识", "看护者", "秘学体验", "离奇失踪", "医学实验受害者"],
            disadvantages: { options: ["身份剥离", "噩梦困扰", "妄想症", "敌意横生", "跟踪者", "身负通缉"], mandatory: [] },
            traits: ["内线谍网(魅力)", "入室贼人(冷静)", "推察入微(逻辑)", "爆破专家(逻辑)", "追索密网(逻辑)", "才思敏锐(逻辑)", "特工精英(暴力)", "创伤抗性(-)"],
            looks: {
                clothes: "精致西服、日常装束、军装制服、迷彩服、长风衣、街头风格、实用着装",
                face: "满是疤痕、平凡无奇、纯真无邪、沉着冷峻、独眼视角、毫无表情、紧张忧虑、布满皱纹、严肃端庄、面带微笑、啃咬不已、方颚鲜明、风度翩翩",
                eyes: "深邃锐利、温和、坚毅无情、回避、凌厉犀利、怀疑不定、好奇、冷漠无情、智慧闪耀、负罪感重、空洞失神",
                body: "健壮有力、圆润饱满、高大威猛、消瘦羸弱、柔韧灵动、体魄刚硬、筋肉显著、普通适中、身材适宜、矮小精悍、迅捷敏锐、猫科般敏捷、弯曲扭转、残破不全、伤痕累累、颤动不已"
            },
            relations: ["选一位角色是你多年的线人。他对你建立+1情感关系。", "你掌握了某位角色过去的机密信息。", "有位角色是你的老友。你们彼此建立+1情感关系。", "有位角色是你的爱人，他对你建立+2的情感关系。", "有位角色是你的同学。你对他建立+1情感关系。"]
        },
        "艺术家": {
            identity: "作家、舞蹈家、演员、画家、录像师、摄影师、设计师、模特、音乐家、歌手、私人教练、美容师、电视节目主持人、导演、记者、博客主",
            secrets: ["咒根深种", "继承者", "精神疾病", "黑暗契约", "犯罪受害者"],
            disadvantages: { options: ["诅咒缠身", "郁病泥沼", "毒品成瘾", "噩梦困扰", "精神分裂", "激情难抑"], mandatory: [] },
            traits: ["艺术天赋(魅力)", "艺术入迷(魅力)", "声名远扬(魅力)", "慧眼如炬(直觉)", "形神合一(感知)", "超感知觉(灵魂)", "禁忌灵感(灵魂)", "耍蛇驭魔(灵魂)"],
            looks: {
                clothes: "新时代风格、哥特风、金属摇滚、浮夸艳丽、设计师品牌、波希米亚风格、磨损旧化、朴素普通风格",
                face: "憔悴不堪、清新可爱、俏丽动人、魅力四射、绝美动人、禁欲主义、疲惫不堪、丰富多彩",
                eyes: "轻松自在、心情愉悦、清澈见底、充满魅力、深邃有力、筋疲力尽、如痴如醉、充满激情",
                body: "可爱俏皮、敏捷灵动、健壮强健、瘦弱羸弱、性感诱人、瘦高挑拔、感性诱惑、畸形扭曲、优雅飘逸、曼妙动人"
            },
            relations: ["有位角色与你的艺术有关。你对他建立+1情感关系。", "有位角色是你的爱人。你对他建立+1情感关系。", "有位角色伤害了你。", "有位角色对你抱有迷恋。他对你建立+2情感关系。", "有位角色委托你创作了一件艺术品。他对你建立+1情感关系。"]
        },
        "复仇者": {
            identity: "家庭主妇(夫)、警察、乞丐、失业者、学生、罪犯、阴谋论者、难民、越狱者、拳击手、寡妇(夫)、封杀名人、破产商人、逃跑的科学实验者",
            secrets: ["看护者", "彼岸返客", "离奇失踪", "犯罪受害者", "医学实验受害者"],
            disadvantages: { options: ["精神性强迫症", "噩梦困扰", "精神分裂", "跟踪者", "身负通缉"], mandatory: ["复仇誓言"] },
            traits: ["动物交流(直觉)", "本能反应(感知)", "超感知觉(灵魂)", "恐吓(暴力)", "求生本能(暴力)", "荣耀准则(-)", "以眼还眼(-)", "狂怒(-)"],
            looks: {
                clothes: "皮质、野外生存、脏污不堪、搭配不协调、披着大衣、随性休闲、磨损破旧",
                face: "憔悴不堪、线条分明、带有童稚特征、满是疤痕、面颊突出、清瘦、重伤疤痕、神情阴郁",
                eyes: "冷酷无情、冰冷刺骨、漠不关心、荒芜空寂、充满悲伤、疲惫不堪、疯狂激昂、深邃幽暗",
                body: "健壮结实、身体畸形、身形丰腴、身体残缺、身材苗条、动物般野性、骨骼突出、消瘦羸弱、轻盈若柳、体型庞大、力大无穷、青春洋溢"
            },
            relations: ["你把秘密托付给了一位角色，如果暴露，你有可能被关进监狱。", "有位角色试图使你忘却复仇誓言。他对你建立+1情感关系。", "有位角色试图帮助你完成复仇誓言。你对他建立+1情感关系。", "有位角色是你的复仇对象。", "有位角色与你的过往存在某种联系。"]
        },
        "破碎者": {
            identity: "流浪汉、逃跑的精神病人、街头小贩、街头表演者、销赃犯、小偷、警察、毒贩、瘾君子、街头艺术家、自由记者、纹身艺术家、虐待幸存者",
            secrets: ["禁忌知识", "精神疾病", "秘学体验", "彼岸返客", "医学实验受害者"],
            disadvantages: { options: ["毒品成瘾", "失控通灵", "强迫症", "精神分裂", "跟踪者"], mandatory: ["支离破碎"] },
            traits: ["街巷耳目(魅力)", "见微知著(直觉)", "无畏蛮勇(感知)", "疯狂瘟疫(灵魂)", "超感知觉(灵魂)", "灵觉通明(灵魂)", "第六感(灵魂)", "迷径寻者(灵魂)"],
            looks: {
                clothes: "流浪汉式、街头风格、破旧西装、异乎寻常、破烂不堪、非主流、轻松休闲、带有性暗示、正式着装、佩戴护身符、脏污衣物",
                face: "憔悴不堪、纹身、面颊突出、野性胡须与长发、痛苦扭曲、愉悦欢笑、忧愁沉重、脏污不堪、疤痕累累、忧心忡忡",
                eyes: "视线模糊、目不转睛、空洞寂寥、神智错乱、惊恐不安、焦虑忧郁、怒火中烧、注意涣散、勇敢无畏、眼神飘忽、深邃锐利、无忧无虑",
                body: "身体抽搐、蹲伏低垂、充满野性、骨瘦如柴、体型庞大、纹身、遍体鳞伤、浓毛覆盖、身形畸变、肥胖臃肿、瘦高笨拙、脏污肮脏、步履蹒跚"
            },
            relations: ["有位角色试图让你重新振作起来。你们彼此建立+1情感关系。", "有位角色在你面临创伤时就在你的身旁。你对他建立+1情感关系。", "有位角色是你的挚友。你对他建立+2情感关系。", "有位角色是你创伤的原因。你对他建立+1情感关系。", "你对一位角色心生愤慨。你对他建立+1情感关系。"]
        },
        "野心家": {
            identity: "律师、商人、白领、董事、首席执行官、顾问、官僚、政治家、阔佬、雅皮士、推销员、培训生、贵族",
            secrets: ["咒根深种", "罪行愧责", "秘学体验", "黑暗契约", "医学实验负责人"],
            disadvantages: { options: ["诅咒缠身", "贪财好利", "鬼魂附身", "满口谎话", "理性主义者", "敌意横生"], mandatory: [] },
            traits: ["激发敬畏(魅力)", "权势之交(魅力)", "人脉网络(魅力)", "声名远扬(魅力)", "无畏(感知)", "谋略之士(逻辑)", "不惜一切(-)", "投机分子(-)"],
            looks: {
                clothes: "平价西服、定制西装、卡其裤搭配衬衫、最新潮流、随性休闲、Polo衫配卡其裤、昂贵服装",
                face: "秀美动人、线条分明、圆润多汗、威风凛凛、轮廓分明、冷酷无情、容光焕发、单调乏味、平淡无奇",
                eyes: "全神贯注、深邃锐利、冷酷无情、疲惫不堪、机智狡黠、敏锐灵动、温暖亲切、权威威严",
                body: "身材苗条、风情万种、高挑纤瘦、圆润丰腴、体型健硕、身材娇小、健美匀称、纤细苗条、曼妙丰满"
            },
            relations: ["有位角色协助你清除了公司里的一位竞争对手。你对他建立+1情感关系。", "有位角色反对你的商业投资。", "有位角色知道你的黑暗秘密。", "有位角色是你的同事。", "你爱上一位角色。你对他建立+2情感关系。"]
        },
        "罪犯": {
            identity: "小偷、抢劫犯、经销商、帮派成员、无家可归者、奖金斗士、腐败警察、执法者、俱乐部老板、勒索者、杀手、行动的代言人、逃跑的司机、骗子、黑帮分子、经销商、保镖",
            secrets: ["家族秘密", "禁忌知识", "罪行愧责", "秘学体验", "犯罪受害者"],
            disadvantages: { options: ["恶名昭彰", "毒品成瘾", "骚扰频发", "血海深仇", "性神经官能症", "身负通缉"], mandatory: [] },
            traits: ["江湖通路(魅力)", "入室賊人(冷静)", "脱逃大师(冷静)", "第六感(灵魂)", "死亡凝视(暴力)", "威胁执行(暴力)", "团伙头目(暴力)", "街头斗士(暴力)"],
            looks: {
                clothes: "街头装、西装、机车手、黑帮、休闲、运动服、专门剪裁、破旧",
                face: "刚毅坚硬、英俊潇洒、遍体鳞伤、饱经风霜、虚伪狡诈、残酷冷酷",
                eyes: "冷酷严肃、深思熟虑、无情冷血、冰冷淡漠、狂乱失控、贪婪无度、深沉黑暗、怀疑不定",
                body: "肌肉健壮、瘦高挑拔、体型庞大、上半身发达、举止优雅、身体残缺、受过重伤、破碎不堪、圆润丰腴、结实魁梧、纤细健硕"
            },
            relations: ["有位角色在警察或其他人追捕你时，把你藏了起来。你对他建立+1情感关系。", "有位角色知道你犯下了一个可怕的罪行。", "有位角色欠你一个人情。", "有位角色与你的对手有关系。", "有位角色在你开始犯罪前，就与你相识。你对他建立+1情感关系。"]
        },
        "定罪者": {
            identity: "神秘学家、邪教逃亡者、警察、首席执行官、侦探、指挥官、黑帮分子、政治家、残保户、业余魔术师、名人、狱卒、商人、花花公子、难民、研究员、网络名人",
            secrets: ["天选之人", "咒根深种", "秘学体验", "黑暗契约", "彼岸返客"],
            disadvantages: { options: ["毒品成瘾", "贪财好利", "鬼魂附身", "噩梦困扰", "跟踪者"], mandatory: ["在劫难逃"] },
            traits: ["秘术研习(逻辑)", "契约束缚(灵魂)", "灵觉通明(灵魂)", "死亡驱动(暴力)", "无情无义(暴力)", "孤注一掷(-)", "命途已定(-)", "拼至末息(-)"],
            looks: {
                clothes: "品牌时尚、风格独特、定制西服、随性自如、搭配风衣的西装、重金属风、设计师品牌、破烂有渍、制服款式、全身黑色、异国情调、商务休闲、血迹斑斑",
                face: "憔悴不堪、骨瘦如柴、线条分明、模特风采、晒得黝黑、面带微笑、疤痕斑斑、有烙印、丰满肉感、苍白无血、红润潮红、阳刚硬朗、忧郁沉痛、病弱",
                eyes: "绝望迷茫、诡计多端、坚定不移、无奈屈服、勇敢无畏、灼伤痕迹、恐惧惊慌、眉清目秀、佩戴墨镜、深邃幽暗、疲倦不堪、倔强执着、充满希望",
                body: "病态羸弱、体格健硕、晒得黝黑、紧绷有力、颤抖不安、发抖害怕、无力衰弱、迷人吸引、肌肉健壮、纤细苗条、肥胖丰腴、曲线优美、残疾痛苦、畏首畏尾、高大威猛、挺胸直背、颓废沮丧"
            },
            relations: ["有位角色知道你的命运已定。你对他建立+1情感关系。", "有位角色无意中推动命运降临在你的身上。他对你建立+1情感关系。", "你利用你之前的成功帮助了某位角色。他对你建立+1情感关系。", "有位角色正在协助你避免注定的命运。你们彼此建立+1情感关系。", "有位角色正在阻挡你逃避注定的命运。"]
        },
        "欺诈师": {
            identity: "模特、待业、网恋诈骗、情人、陪侍女郎、继承人、富豪旅行者、聚会狂、秘书、派对策划者、婚姻诈骗者、欺诈师、男妓、电子诈骗、小偷、告密者、色情明星",
            secrets: ["继承者", "精神疾病", "秘学体验", "黑暗契约", "犯罪受害者"],
            disadvantages: { options: ["诅咒缠身", "贪恋", "满口谎话", "血海深仇", "性神经官能症", "身负通缉"], mandatory: [] },
            traits: ["迷魂夺魄(魅力)", "情感骗子(魅力)", "目挑心招(魅力)", "背后捅刀(冷静)", "明察秋毫(感知)", "见微知著(直觉)", "积怨于心(-)", "牵线御人(-)"],
            looks: {
                clothes: "贴身剪裁、设计师品牌、性感迷人、大胆露骨、波希米亚风格、时髦流行、端庄适宜、浮夸艳丽、专属定制、旧式磨损、引人注目",
                face: "小巧玲珑、俊潇洒、保持童稚、青春焕发、轮廓分明、刻薄、柔和细腻、圆润可爱、惊艳动人、纯真无邪、庄重有威、笑容愉悦",
                eyes: "调皮俏皮、闪烁生辉、深邃有力、易受伤害、纯洁无瑕、秀外慧中、富有同情、友好亲切、眼眸大大、深邃锐利、充满温情",
                body: "苗条修长、性感妩媚、阳刚硬朗、曲线婀娜、高大威猛、感性诱惑、曼妙丰满、身材娇小、健美健硕、青春洋溢、健壮结实、高挑修长、矮小精悍、消瘦纤细、线条流畅"
            },
            relations: ["有位角色帮助你杀死了一个敌人。你对他建立+1情感关系。", "有位角色认识你的一个受害者。", "有位角色在你罕见地表露本我是遇见了你。", "有位角色是你的现任受害者。你对他建立+2情感关系。", "有位角色受你吸引。他对你建立+1情感关系。"]
        },
        "后裔": {
            identity: "古文物收藏家、贵族、作家、流浪汉、纹身艺术家、神秘学家、教派逃亡者、牧师、继承人、失业者、白领、工匠、林务员",
            secrets: ["天选之人", "家族秘密", "继承者", "秘学体验", "黑暗契约"],
            disadvantages: { options: ["诅咒缠身", "鬼魂附身", "噩梦困扰", "恐惧症", "压抑记忆", "跟踪者"], mandatory: [] },
            traits: ["权势之交(魅力)", "见微知著(直觉)", "秘术藏书(逻辑)", "通灵魔器(灵魂)", "契约束缚(灵魂)", "超感知觉(灵魂)", "内在之力(灵魂)", "暗中守护(-)"],
            looks: {
                clothes: "复古风格、休闲款式、磨破旧化、定制西服、层层堆叠、独特设计、全黑着装",
                face: "稚气未脱、线条分明、愁云密布、疤痕斑斑、虛情假意、病态憔悴、容光焕发、特征显著、紧张拘谨、圆润可爱",
                eyes: "疲惫不堪、漠不关心、忧心忡忡、意志坚定、疑虑重重、勇敢无畏、纯真无暇、心神不宁",
                body: "体弱多病、力大无穷、骨瘦如柴、身材矮小、病态羸弱、身形纤细、健美挺拔、高大魁梧、纤细修长、弯曲佝偻、僵硬不便、身材苗条"
            },
            relations: ["有位角色是你的青梅竹马。你们彼此建立+2情感关系。", "有位角色看到了追杀你的东西。你对他建立+1情感关系。", "你暗恋某位角色。你对他建立+2情感关系。", "有位角色是你的联络人。", "有位角色与你的黑暗秘密有着密切联系。你对他建立+1情感关系。"]
        },
        "侦探": {
            identity: "巡警、私家侦探、律师、调查员、保安、调查记者、情报人员、警探、灵媒、黑客、密码学家、阴谋论者",
            secrets: ["禁忌知识", "罪行愧责", "秘学体验", "彼岸返客", "离奇失踪"],
            disadvantages: { options: ["毒品成瘾", "病弱", "噩梦困扰", "压抑记忆", "跟踪者"], mandatory: [] },
            traits: ["话术(冷静)", "审讯之术(直觉)", "本能反应(感知)", "察微观众(感知)", "如影随形(感知)", "现场调查(逻辑)", "梦境行者(灵魂)", "超感知觉(灵魂)"],
            looks: {
                clothes: "正式西装、粗花呢材质、潮流时尚、轻松休闲、严肃正式、商务风格、磨破旧化",
                face: "友善和蔼、线条分明、圆润满面、汗水涔涔、纯真无邪、意志坚定、疲惫不堪",
                eyes: "充满同情、漠不关心、细长眯眼、敏锐犀利、疑虑重重、温情脉脉、关心体贴",
                body: "纤细修长、丰满肥胖、纤细健硕、结实强壮、身材魁梧、肌肉发达"
            },
            relations: ["有位角色拯救你于危难之中。你对他建立+1情感关系。", "有位角色诱使你保护你的调查对象。", "你帮助了一位角色解开了谜团。他对你建立+1情感关系。", "有位角色是你的同事。你们彼此建立+1情感关系。", "有位角色是你的线人。你对他建立+1情感关系。"]
        },
        "玩偶": {
            identity: "儿童选美选手、模特、脱衣舞娘、花瓶、男妓、演员、逃跑的试验品、高中舞会皇后、视频博主、电视真人秀名人、色情明星、陪侍女郎、虐待求生专家、被监禁的无辜者、被拐卖人",
            secrets: ["天选之人", "罪行愧责", "秘学体验", "犯罪受害者", "医学实验受害者"],
            disadvantages: { options: ["骚扰频发", "恐惧症", "跟踪者", "禁脔", "性神经官能症"], mandatory: ["魂牵梦绕"] },
            traits: ["我见犹怜(魅力)", "背后捅刀(冷静)", "心如冰霜(冷静)", "潜踪匿迹(冷静)", "神性示现(灵魂)", "勾魂摄魄(灵魂)", "创伤抗性(-)", "咬紧牙关(-)"],
            looks: {
                clothes: "性感吸引、蓬松飘逸、迷人诱惑、别具一格、时尚前沿、实用性低、引人注目、哥特风格、华美、波希米亚风、色彩鲜艳、纯洁无邪、破烂、线条利落",
                face: "美丽动人、笑容灿烂、忧伤凝重、稚气未脱、鼻青脸肿、轮廓分明、令人安心、精心化妆、中性模糊、喜悦洋溢",
                eyes: "天真烂漫、美目盼兮、迷人魅力、五彩斑斓、惊恐不安、紫罗兰色、苍白无神、蓝宝石般、翠绿迷离、黄金闪耀、饥渴深邃、淡漠冷清、大眼睛、朦胧遮掩、心碎失意、风情万种",
                body: "柔弱娇小、吸引力十足、小巧玲珑、优雅飘逸、娇小玲珑、曲线动人、健美挺拔、庄重端庄、健美匀称、纤细苗条、柳条婀娜、中性风格、高挑身姿"
            },
            relations: ["有位角色爱上了你。他对你建立+2情感关系。", "有位角色在照顾你。你们彼此建立+1情感关系。", "有位角色是你的暗恋对象。你对他建立+2情感关系。", "有位角色把你从奴役中解放了出来。你们彼此建立+1情感关系。", "有位角色对你心怀嫉妒。"]
        },
        "漂泊者": {
            identity: "流浪汉、游民、离家出走者、证人保护者、逃兵役者、小混混、背包客、难民、越狱者、旅行推销员、信使、日结工、外来者",
            secrets: ["咒根深种", "家族秘密", "精神疾病", "彼岸返客", "居无定所"],
            disadvantages: { options: ["诅咒缠身", "骚扰频发", "鬼魂附身", "精神分裂", "跟踪者", "身负通缉"], mandatory: [] },
            traits: ["街巷耳目(魅力)", "司机(冷静)", "临机应变(冷静)", "入世圆融(直觉)", "心思玲珑(直觉)", "驭车技艺(感知)", "通灵魔器(灵魂)", "超感知觉(灵魂)"],
            looks: {
                clothes: "磨旧不堪、古怪别致、摩托风格、破损破烂、实用性强、街头穿搭、野外求生、层层叠加、季节不符、廉价西服、流浪风格",
                face: "病理毁容、纯真无瑕、饱经风霜、脏污斑斑、和蔼、刚强、身上纹身、疤痕累累、印象深刻",
                eyes: "眼神浑浊、疲惫无力、不安焦虑、失明盲目、独眼视角、血丝密布、紧张拘谨、怀疑警觉、恐惧害怕、欢笑愉悦、讽刺挖苦、聪明睿智",
                body: "纤细瘦弱、骨瘦如柴、跛足蹒跚、迅速敏捷、肮脏不洁、遍体鳞伤、魁梧巨大、身材娇小、身形苗条、中性模糊、高大挺拔、比例失调、悠然自得、紧张焦虑、畸形扭曲、身体纹身、充满野性"
            },
            relations: ["有位角色有时会让你留在他身边。你对他建立+1情感关系。", "有位角色帮助你摆脱困境。你对他建立+1情感关系。", "有位角色是你的老朋友。你对他建立+2情感关系。", "有位角色是你在黑社会认识的。", "有位角色给你一些临时工作。"]
        },
        "中间人": {
            identity: "黑手党党首、商人、房地产经纪人、经销商、餐馆老板、俱乐部老板、销赃犯、放高利贷、赌徒、顾问、敲诈者、罪犯、参谋",
            secrets: ["禁忌知识", "犯罪愧责", "继承者", "黑暗契约", "犯罪受害者"],
            disadvantages: { options: ["竞争对手", "诅咒缠身", "贪财好利", "妒心难控", "满口谎话", "跟踪者"], mandatory: [] },
            traits: ["花言巧语(魅力)", "江湖通路(魅力)", "暗藏底牌(冷静)", "背后捅刀(冷静)", "犯罪党首(冷静)", "探人隐秘(直觉)", "第六感(灵魂)", "行遍尘寰(-)"],
            looks: {
                clothes: "正式西装、街头风格、皮质、日常休闲、异乎寻常、豪华奢侈、运动风格服饰",
                face: "愉快和蔼、外貌英俊、魅力四射、面颊骨感、遍体鳞伤、纯真无邪、丰腴圆润、坦率开朗",
                eyes: "眉开眼笑、深思熟虑、冷漠无情、谦卑顺从、机智狡诈、坚强刚毅、迷茫困惑、审慎评估",
                body: "宽阔壮实、健美运动型、瘦骨嶙峋、性感魅力、忽略腿部锻炼、高挑纤细、结实魁梧"
            },
            relations: ["有位角色为了帮你摆脱困境而挨一顿毒打。你对他建立+1情感关系。", "有位角色惹了麻烦，却让你承担。", "有位角色欠你人情。", "有位角色为你干事。", "有位角色是你的业务联系人。"]
        },
        "神秘学者": {
            identity: "古物学家、灵媒、驱魔师、语言学家、失业者、神学家、教授、停尸房雇员、青少年、学生、官僚、残保户、图书管理员、新人教者、泰勒玛",
            secrets: ["禁忌知识", "看护者", "秘学体验", "黑暗契约", "显灵"],
            disadvantages: { options: ["罪责困心", "鬼魂附身", "失控通灵", "噩梦困扰", "压抑记忆", "跟踪者"], mandatory: [] },
            traits: ["诡计多端(直觉)", "秘术藏书(逻辑)", "学徒术士(灵魂)", "梦境行者(灵魂)", "超感知觉(灵魂)", "驱魔师(灵魂)", "灵觉通明(灵魂)", "求知若渴(-)"],
            looks: {
                clothes: "全身黑色、西服配风衣、嬉皮风格、神秘符号装饰、轻松休闲、灵性风情、华美耀眼、闪光熠熠、破烂不堪、新时代风尚、独树一帜、谨慎内敛、引人瞩目",
                face: "浓密胡须、黑发苍肤、面颊骨感、面容畸形、历经沧桑、姿色动人、紧张焦虑、脸色苍白、漠然无情、满脸轻蔑、无趣乏味、皱纹斑斑、显露老态",
                eyes: "眼神空洞、清澈透亮、发狂失控、锐利刺骨、引人注目、审视打量、目光遥远、疲倦不堪、失意颓废、权力欲望、忧伤凝视",
                body: "骨瘦如柴、伤痕累累、伤痕斑斑、高大威猛、颤抖不已、身上纹身、烧伤痕迹、纤细轻盈、弯曲佝偻、瘦高挑拔、肥胖臃肿、僵硬呆板、魅力四射"
            },
            relations: ["有位角色与你失去的重要之人有所联系。你对他建立+1情感关系。", "有位角色是你的朋友。你对他建立+1情感关系。", "有位角色协助你寻找书籍、信息与造物。你对他建立+1情感关系。", "有位角色憎恨你对他的所作所为，尽管你依旧对他怀有爱意。你对他建立+1情感关系。"]
        },
        "先知": {
            identity: "祭司、牧师、伊玛目、拉比、教派领袖、教派成员、教派逃亡者、先知、灵媒、女巫、传教士、医治者、预言家、崇拜者、信徒、偶像破坏者、长老、神谕师、古鲁",
            secrets: ["天选之人", "禁忌知识", "看护者", "秘学体验", "显灵"],
            disadvantages: { options: ["诅咒缠身", "狂热信徒", "骚扰频发", "失控通灵", "性神经官能病", "跟踪者"], mandatory: [] },
            traits: ["魅力之辉(灵魂)", "教团领袖(灵魂)", "超感知觉(灵魂)", "驱魔师(灵魂)", "治愈之手(灵魂)", "狂言惑心(灵魂)", "圣斗士(-)", "好好心肠(-)"],
            looks: {
                clothes: "西装、神袍、传统、有机材料、波希米亚风格、轻松休闲、大衣帽子、街头穿搭、独特奇异、磨破旧化",
                face: "外貌英俊、皮肤光滑、魅力四射、带有童稚、威严霸气、面容狭长、贵族气质、开朗热情、禁欲苦行",
                eyes: "眉开眼笑、深邃有力、疯狂失控、智慧深邃、宽容大度、迷人吸引、锐利刺骨、热情奔放",
                body: "健壮、纤细、瘦弱、小巧玲珑、纤细修长、病态羸弱、圆润丰满、结实坚硬、活力四射、曼妙丰腴"
            },
            relations: ["有位角色与你信仰相同。", "有位角色拯救了你。你对他建立+1情感关系。", "有位角色否定你的神明。", "你拯救某位角色的不朽灵魂。他对你建立+1情感关系。", "有位角色是你的爱人。你对他建立+1情感关系。"]
        },
        "浪人": {
            identity: "合约杀手、职业杀手、特工、特种兵、军事实验体、狙击手、疯狂杀手",
            secrets: ["咒根深种", "看护者", "秘学体验", "医学实验受害者", "显灵"],
            disadvantages: { options: ["诅咒缠身", "鬼魂附身", "黑暗印记", "血海深仇", "噩梦困扰", "身负通缉"], mandatory: [] },
            traits: ["武器大师(冷静)", "千面幻影(直觉)", "脱身计划(感知)", "追踪逐影(逻辑)", "第六感(灵魂)", "风驰电掣(暴力)", "狙击手(暴力)", "心如止水(-)"],
            looks: {
                clothes: "正式西装、低调内敛、深沉黑色、磨旧风格、遮掩巧妙、奢侈华丽、时尚前卫、实用耐穿",
                face: "消瘦憔悴、面无表情、平淡无奇、和蔼可亲、疤痕斑斑、体魄刚毅、秀美动人、肌肤光滑",
                eyes: "严峻冷峻、审慎评估、冷静沉稳、神秘遮掩、忧郁沉思、无情冷酷、挑衅十足",
                body: "身姿优雅、健美运动型、小巧玲珑、疤痕累累、力大无穷、体型庞大、纤细健壮、骨瘦如柴、肌肉健硕、饱经风霜"
            },
            relations: ["有位角色知道你的真实身份。你们彼此建立+1情感关系。", "有位角色以你的化名认识了你。", "有位角色知道你最深的恐惧。", "有位角色欠你一条命。他对你建立+1情感关系。", "你对某位角色的伙伴抱有秘而不宣的激烈感情。你对他建立+2情感关系。"]
        },
        "科学家": {
            identity: "医生、心理学家、外科医生、发明家、工程师、技术员、心理治疗师、物理学家",
            secrets: ["禁忌知识", "精神疾病", "医学实验负责者", "彼岸返客", "医学实验受害者"],
            disadvantages: { options: ["恶名昭彰", "实验出错", "狂热信徒", "精神性强迫症", "压抑记忆", "身负通缉"], mandatory: [] },
            traits: ["战地医疗(逻辑)", "发明家(逻辑)", "科研专家(逻辑)", "超感知觉(灵魂)", "天资之质(灵魂)", "植入指令(灵魂)", "通晓秘典(-)", "工作狂(-)"],
            looks: {
                clothes: "正式西装、磨旧污渍、休闲随性、实用耐穿、搭配大衣和帽子、独特风格、实验室专用白大褂、斑驳沾渍、整洁得体、耐用服饰",
                face: "饱经风霜、方形轮廓、疤痕斑斑、面颊骨感、圆润多汗、特征显著、疲惫憔悴、风尘仆仆、神情严肃",
                eyes: "深思熟虑、无神迷茫、目光锐利、怒火中烧、发狂失控、心神不宁、威严霸道",
                body: "体弱多病、棱角突出、健壮结实、超重肥胖、骨瘦如柴、瘦弱消瘦、纤细苗条、高大挺拔、驼背弯曲、身形奇异"
            },
            relations: ["有位角色得到了你的帮助。他对你建立+1情感关系。", "有位角色在协助你实验时出了大错。", "有位角色知道你梦境的细节。", "有位角色自愿参加你的实验。你对他建立+1情感关系。", "有位角色参与了你的研究。", "你对某位角色的伙伴抱有秘而不宣的激烈感情。你对他建立+2情感关系。"]
        },
        "探求者": {
            identity: "学生、失业者、博客、黑客、活动家、学者、研究员、超心理学家、作家、记者、小偷、灵媒、阴谋论者",
            secrets: ["家族秘密", "禁忌知识", "看护者", "秘学体验", "离奇失踪"],
            disadvantages: { options: ["诅咒缠身", "鬼魂附身", "噩梦困扰", "压抑记忆", "跟踪者", "身负通缉"], mandatory: [] },
            traits: ["跑酷(冷静)", "访问暗网(感知)", "锐利目光(感知)", "数字骇客(逻辑)", "未雨绸缪(逻辑)", "超感知觉(灵魂)", "顽强不屈(灵魂)", "创伤抗性(-)"],
            looks: {
                clothes: "呆板书生风、二手旧衣、皮质风格、非主流、日常休闲、耐穿结实、异味难闻、舒适、沾有污渍、撕裂破损",
                face: "布满皱纹、生气勃勃、俏皮可爱、保持童稚、肤色苍白、神情严肃、伤痕累累、纯真无暇",
                eyes: "清澈明亮、坚定不移、疲惫无力、血丝斑斑、疑虑重重、好奇探索、逃避回避、怀疑不定、深思熟虑",
                body: "高挑瘦长、肌肉线条、健壮有力、易碎脆弱、身材魁梧、身形畸变、纤细轻盈、丰腴圆润、蜷曲弯腰、矮小精悍、青春洋溢"
            },
            relations: ["你把秘密托付了某位角色，而这个秘密足以把你送进监狱。", "有位角色在你调查时提供了帮助，你对他建立+1情感关系。", "有位深得你的尊敬。你对他建立+1情感关系。", "有位角色救了你的命。你对他建立+1情感关系。", "你发现了某位角色犯下罪行、淫秽或极其可耻的行为。"]
        },
        "老兵": {
            identity: "特工、军人、街头混混、雇佣兵、综合格斗选手、军官、保安、保镖、杀手、战争难民、军警、退休人员、无家可归的老兵",
            secrets: ["犯罪愧责", "彼岸返客", "犯罪受害者", "医学实验受害者", "显灵"],
            disadvantages: { options: ["毒品成瘾", "鬼魂附身", "噩梦困扰", "恐惧症", "压抑记忆", "跟踪者"], mandatory: [] },
            traits: ["狩猎者(感知)", "本能反应(感知)", "求生专家(感知)", "苦痛之音(灵魂)", "武术专家(暴力)", "指挥官(暴力)", "神枪手(-)", "久经沙场(-)"],
            looks: {
                clothes: "街头风格、运动服饰、血渍斑斑、日常休闲、迷彩装、制服、实用型服装",
                face: "坚毅刚强、质地粗糙、满是疤痕、历经沧桑、脆弱易损、表情严厉、面部畸形",
                eyes: "冷酷无情、死寂沉、凄凉、炽烈燃烧、悲伤哀愁、怒火中烧、威严霸道",
                body: "紧凑结实、体魄不拔、伤痕累累、体型庞大、健硕魁梧、身手敏捷、高大挺拔、肌肉饱满、线条分明、力量强劲、遭受重创"
            },
            relations: ["有位角色在你需要帮助时对你施以援手。你对他建立+1情感关系。", "有位角色在你最需要他的时候抛弃了你。", "有位角色与你并肩作战。你们彼此建立+1情感关系。", "有位角色倾听了你的战争故事。", "有位角色目睹了你失去控制的模样。"]
        },
        "沉眠者": {
            identity: "任意选择",
            secrets: null, // 从全局抽取
            disadvantages: null, // 从全局抽取
            traits: ["无"],
            looks: {
                clothes: "主流时尚、潮流风格、端庄得体、运动服饰、牛仔裤搭配、正式西装、流行趋势、波希米亚风、街头黑帮、低调匿名、全身黑色、书呆气质、时髦精致、英俊潇洒、挑逗性感、迷人吸引、平凡无奇、另类特立",
                face: "面庞可爱、疲倦之态、勉强的微笑、面色红润、表情坚硬、柔软细腻、肿胀肉感、骨瘦如柴、苍白无血、无表情呆板、秀丽迷人、阳刚之气、温柔细腻、严肃威严、长脸型、圆润面庞、方正轮廓、蓄有胡须、晒得黝黑",
                eyes: "回避、大眼、轻蔑神情、调情眼波、愉悦笑意、纯真无邪、强烈热切、昏昏欲睡、控制欲强、要求苛刻、幽暗深邃、光亮闪烁、困惑迷茫、无趣乏味",
                body: "身形瘦削、肌肉健硕、身材丰满、纤细瘦弱、高大威猛、身材矮小、体型健壮、身材苗条、力大无穷、健壮结实、佝偻身形、挺胸直背、轻盈活泼、神态平和、丰富表情、神经质、紧张不安、身体虚弱"
            },
            relations: ["有位角色是你的同事。", "有位角色是你的挚爱或密友。双方建立+1情感关系。", "有位角色是你的黑暗秘密有所牵连。", "你暗中关注着某位角色的社交媒体。你对他建立+1情感关系。", "有位角色拥有的事物使你感到嫉妒。"]
        },
        // === 觉悟者原型 ===
        "畸变者": {
            identity: "流浪汉、军人、精神病患、职业拳手、逃逸实验品、狂热科学家、神秘学者、猎人、罪犯、怪人、杀人犯、退伍军人",
            secrets: ["诅咒缠身", "黑暗契约", "家族秘密", "医学实验受害者", "秘学体验"],
            disadvantages: { options: ["仇深似海", "诅咒缠身", "精神分裂", "妒心难控", "跟踪者"], mandatory: ["创造者"] },
            abilities: ["黑暗视觉", "不朽之躯", "坚不可摧", "往世回忆", "天生武器", "迅捷瞬速", "自愈之力", "超凡巨力"],
            limitations: ["食人恶癖", "狩猎本能", "非人之相", "敏感之症", "失控变形"],
            looks: {
                clothes: "破烂、沾血、皮革、运动服饰、街头打扮、衣不蔽体",
                face: "风霜雕琢、刚毅坚硬、面目畸形、丑陋难堪、满脸胡须、严肃冷峻、魅力非凡、伤痕累累",
                eyes: "怒火中烧、狂热燃烧、失魂落魄、心灰意冷、悲伤沉郁、好奇探索、空洞无神、怀疑审视",
                body: "魁梧巨大、身形畸变、筋肉纠结、轻捷优雅、佝偻蜷曲、形态奇异、伤痕累累、肌肉发达、高大挺拔"
            },
            relations: ["选一位角色在你还是人类的时候就认识你。你对他建立+1情感关系。", "你曾无意间伤害了其他角色中的一位。", "选一位角色曾窥见你的真实面目。", "你对一位角色心怀恋情。你对他建立+2情感关系。", "有位角色相信你能保持自控。他对你建立+1情感关系。"]
        },
        "死亡魔法师": {
            identity: "伏都祭司、殡仪师、书商、贵族、金邦谷祭师、苦行僧、历史教授、高中生、教师、神秘学家、通灵者、无业游民、古董商",
            secrets: ["诅咒缠身", "黑暗契约", "守护者", "禁忌知识", "秘学体验"],
            disadvantages: { options: ["恶名昭彰", "诅咒缠身", "仇深似海", "噩梦困扰", "跟踪者", "黑暗印记"], mandatory: ["死亡烙印"] },
            abilities: ["再生机遇", "黑暗光环", "阅历深厚", "灵活应变", "专家精通", "熟能生巧", "魔法大师", "灵符法宝"],
            limitations: ["专精领域"],
            looks: {
                clothes: "古典、磨损、休闲、独特设计、昂贵华丽、深邃黑色",
                face: "沧桑、疲倦、愧疚、忧虑、精神、忧郁、平静、苍白",
                eyes: "高傲、充满活力、冷酷、勇敢、疲惫、迷茫、青春洋溢、温情脉脉",
                body: "魁梧、骨感、纤细、消瘦、威猛、健壮、端庄、体弱"
            },
            relations: ["选一位角色是你的盟友。你对他建立+1情感关系。", "选一位角色因你而陷入困境。", "选一位角色曾向你求助，事关生死之谜。", "选一位角色对你心存畏惧。", "选一位角色是你的敌人。"]
        },
        "门徒": {
            identity: "议员、宗教领导、企业总裁、贵族、帮派头目、黑道教父、神秘学家、视频博主、顾问、主教、研究员、警察、高中女王、名人、富豪、商人、无家可归者、退休者、官僚",
            secrets: ["选民", "守护者", "罪行愧责", "秘学体验", "黑暗契约"],
            disadvantages: { options: ["诅咒缠身", "狂热信徒", "贪财好利", "仇深似海", "跟踪者"], mandatory: ["门生"] },
            abilities: ["神性之力", "阅历丰富", "操纵伪世", "仪式领袖", "开辟通道", "召灵唤物", "圣殿护卫", "坚毅不屈"],
            limitations: ["至高链接"],
            looks: {
                clothes: "耀眼夺目、正式西服、神职长袍、异乎寻常、怪诞不经、神秘符号、灵性打扮、端庄合宜",
                face: "心安神泰、鲜明突出、纯真无邪、领袖气质、淡漠超然、历经沧桑、自信坚定",
                eyes: "神秘莫测、智慧闪耀、深思熟虑、审视打量、充满激情、扣人心弦光、渴求权力",
                body: "庄严威严、紧张挺拔、魁梧巨大、纤细修长、饱经沧桑、伤痕累累、优雅轻盈、脆弱不堪"
            },
            relations: ["选一位角色是你的盟友，你对他建立+1情感关系。", "选一位角色是你所效忠的至高存在的敌人。", "选一位角色接受过你的帮助，他对你建立+1情感关系。", "选一位角色厌恶你。", "选一位角色曾保护过对你来说非常宝贵的东西，你对他建立+1情感关系。"]
        },
        "亡灵": {
            identity: "行骗高手、时尚模特、纨绔子弟、银幕演员、贵族、艺术家、俱乐部老板、复仇者、逃脱的实验品、音乐家、政治家、神秘学家、风尘女子",
            secrets: ["诅咒缠身", "秘学体验", "黑暗契约", "彼岸返客", "犯罪受害者"],
            disadvantages: { options: ["诅咒缠身", "狂热信徒", "贪财好利", "仇深似海", "门生", "跟踪者"], mandatory: ["追捕者"] },
            abilities: ["迷人魅力", "命令之音", "灵体化", "坚不可摧", "往世记忆", "心灵操纵", "心灵遥感"],
            limitations: ["嗜血之性", "外力控制", "敏感之症", "噬魂之渴", "符印束缚"],
            looks: {
                clothes: "复古、非主流、时尚、曝露、引人注目、异乎寻常",
                face: "皎洁、绝美、冷酷、苍白、纯真、庄重、中性、哀愁",
                eyes: "淡漠如水、深邃幽暗、热烈迫切、狡黠多谋、狂乱失控、善解人意、深含关怀",
                body: "骨瘦如柴、曼妙诱人、颤栗不安、曲线丰腴、虚弱多病、畸形扭曲、阴阳中性、轻盈若絮"
            },
            relations: ["选一位角色是你的盟友，你对他建立+1情感关系。", "选一位角色因你而深陷不幸。", "选一位角色就死亡之事曾向你寻求援助。", "选一位角色对你心存畏惧。", "选一位角色是你的敌人。"]
        }
    }
};

// 动态构建全局身份池
(() => {
    let allIds = [];
    for (const [key, data] of Object.entries(KULT_LIBRARY.archetypes)) {
        if (key === "沉眠者") continue; 
        if (data.identity) {
            let parts = data.identity.split(/[、]/).map(s => s.trim()).filter(s => s);
            allIds.push(...parts);
        }
    }
    KULT_LIBRARY.global.identities = [...new Set(allIds)]; // 去重
})();

// === 3. 辅助函数 ===
function sample(arr, count) {
    if (!arr || arr.length === 0) return [];
    let shuffled = arr.slice(0), i = arr.length, min = i - count, temp, index;
    while (i-- > min) {
        index = Math.floor((i + 1) * Math.random());
        temp = shuffled[index];
        shuffled[index] = shuffled[i];
        shuffled[i] = temp;
    }
    return shuffled.slice(min);
}

function splitAndPick(str, count = 1) {
    if (!str) return "";
    let parts = str.split(/[、]/).map(s => s.trim()).filter(s => s);
    let picks = sample(parts, Math.min(count, parts.length));
    return picks.join("、"); 
}

function generateAttributes() {
    let passNames = ["体魄", "反应", "意志"];
    let passVals = sample(["+2", "+1", "+0"], 3);
    let passStr = passNames.map((n, i) => `${n}${passVals[i]}`).join(", ");

    let actNames = ["魅力", "冷静", "直觉", "感知", "逻辑", "灵魂", "暴力"];
    let actVals = sample(["+3", "+2", "+1", "+1", "+0", "-1", "-2"], 7);
    let actStr = actNames.map((n, i) => `${n}${actVals[i]}`).join(", ");

    return { pass: passStr, act: actStr };
}

// === 4. 指令逻辑 ===
const cmdKultChar = seal.ext.newCmdItemInfo();
cmdKultChar.name = 'kchar';
cmdKultChar.help = `KULT 角色生成器
================================
指令: .kchar [原型名称/help]
示例: 
  .kchar          (随机生成任意原型)
  .kchar 浪人     (指定生成浪人)
  .kchar 沉眠者   (生成沉眠者，身份从全局随机)
  .kchar help     (查看帮助)
  
原型列表：
  [觉察者] 学术家, 特工, 艺术家, 复仇者, 破碎者, 野心家, 罪犯, 定罪者, 欺诈师, 后裔, 侦探, 玩偶, 漂泊者, 中间人, 神秘学者, 先知, 浪人, 科学家, 探求者, 老兵
  [沉眠者] 沉眠者
  [觉悟者] 畸变者, 死亡魔法师, 门徒, 亡灵
================================`;

cmdKultChar.solve = function (ctx, msg, argv) {
    const targetArg = argv.getArgN(1);
    
    // Help 指令
    if (targetArg === 'help' || targetArg === '-h') {
        const ret = seal.ext.newCmdExecuteResult(true);
        ret.showHelp = true;
        return ret;
    }

    let archetypeKey = "";
    
    // 查找原型 key
    if (targetArg) {
        const keys = Object.keys(KULT_LIBRARY.archetypes);
        archetypeKey = keys.find(k => k.includes(targetArg));
        if (!archetypeKey) return seal.ext.newCmdExecuteResult(true); 
    } else {
        const keys = Object.keys(KULT_LIBRARY.archetypes);
        archetypeKey = keys[Math.floor(Math.random() * keys.length)];
    }

    const data = KULT_LIBRARY.archetypes[archetypeKey];
    
    // 身份生成
    let randomIdentity;
    if (archetypeKey === "沉眠者") {
        randomIdentity = sample(KULT_LIBRARY.global.identities, 1)[0];
    } else {
        randomIdentity = splitAndPick(data.identity, 1);
    }

    let output = `>>> KULT 角色生成: ${archetypeKey}\n`;
    output += `--------------------\n`;
    output += `【身份建议】\n${randomIdentity}\n\n`;
    
    // 黑暗秘密 logic
    if (archetypeKey === "沉眠者") {
        output += `【黑暗秘密】\n(潜意识) ${sample(KULT_LIBRARY.global.secrets, 1)[0]}\n\n`;
    } else {
        output += `【黑暗秘密】\n${sample(data.secrets, 1)[0]}\n\n`;
    }
    
    // 缺陷 logic
    let disList = [];
    if (archetypeKey === "沉眠者") {
        disList = sample(KULT_LIBRARY.global.disadvantages, 2);
    } else {
        if (data.disadvantages.mandatory) {
            disList.push(...data.disadvantages.mandatory);
        }
        let neededDis = 2 - disList.length;
        if (neededDis > 0) {
            let options = data.disadvantages.options.filter(x => !disList.includes(x));
            disList.push(...sample(options, neededDis));
        }
    }
    output += `【缺陷】\n- ${disList.join('\n- ')}\n\n`;
    
    // 干扰或特质/能力
    if (archetypeKey === "沉眠者") {
        let dists = sample(KULT_LIBRARY.global.distractions, 2);
        output += `【干扰】\n- ${dists.join('\n- ')}\n\n`;
    } else {
        if (data.traits) {
            output += `【特质】\n- ${sample(data.traits, 3).join('\n- ')}\n\n`;
        } else if (data.abilities) {
            output += `【能力】\n- ${sample(data.abilities, 3).join('\n- ')}\n\n`;
            output += `【限制】\n- ${sample(data.limitations, 2).join('\n- ')}\n\n`;
        }
    }

    // 属性自动随机分配
    let attrs = generateAttributes();
    output += `【属性分配】\n[被动] ${attrs.pass}\n[主动] ${attrs.act}\n\n`;
    
    // 外表随机抽取 (每项3个词)
    let lookClothes = splitAndPick(data.looks.clothes, 3);
    let lookFace = splitAndPick(data.looks.face, 3);
    let lookEyes = splitAndPick(data.looks.eyes, 3);
    let lookBody = splitAndPick(data.looks.body, 3);
    
    output += `【外表特征】\n`;
    output += `装束: ${lookClothes}\n`;
    output += `面容: ${lookFace}\n`;
    output += `眼睛: ${lookEyes}\n`;
    output += `身材: ${lookBody}\n\n`;
    
    // 关系抽取 (2条 + 固定文本)
    let rels = sample(data.relations, 2);
    output += `【关系纽带】\n- ${rels.join('\n- ')}\n`;
    output += `\n确立三个额外关系：一个普通（0），一个重要（+1），一个关键（+2）。`;

    seal.replyToSender(ctx, msg, output);
    return seal.ext.newCmdExecuteResult(true);
};

// 注册指令
ext.cmdMap['kchar'] = cmdKultChar;
ext.cmdMap['kultchar'] = cmdKultChar;